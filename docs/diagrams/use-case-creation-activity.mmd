flowchart TD
    Start([User initiates transaction creation]) --> CheckIdempotency{Idempotency key<br/>provided?}
    
    %% Idempotency Key Branch
    CheckIdempotency -->|Yes| ValidateKeyFormat[Validate idempotency key format]
    CheckIdempotency -->|No| ValidateFormat[Validate request format]
    
    ValidateKeyFormat --> KeyFormatValid{Format<br/>valid?}
    KeyFormatValid -->|No| A5_1[Return error: Invalid key format]
    A5_1 --> End1([End: No transaction created])
    
    KeyFormatValid -->|Yes| CheckPreviousResponse[Check for previous response]
    CheckPreviousResponse --> ResponseExists{Previous<br/>response<br/>exists?}
    
    ResponseExists -->|Yes| CheckExpired{Response<br/>expired?}
    ResponseExists -->|No| A5_2_4[New key: Continue with basic flow]
    A5_2_4 --> ValidateFormat
    
    CheckExpired -->|Yes| A5_2_3[Remove expired record<br/>Continue with basic flow]
    A5_2_3 --> ValidateFormat
    
    CheckExpired -->|No| CheckMatch{Request matches<br/>previous?}
    CheckMatch -->|Yes| A5_2_1[Return previous response]
    A5_2_1 --> End2([End: Previous response returned])
    
    CheckMatch -->|No| A5_2_2[Return error: Conflict]
    A5_2_2 --> End3([End: No transaction created])
    
    %% Basic Flow
    ValidateFormat --> FormatValid{Format<br/>valid?}
    FormatValid -->|No| A6[Return error: Malformed request]
    A6 --> End4([End: No transaction created])
    
    FormatValid -->|Yes| CheckFeature[Validate feature availability]
    CheckFeature --> FeatureAvailable{Feature<br/>available?}
    FeatureAvailable -->|No| A1[Return error: Feature unavailable]
    A1 --> End5([End: No transaction created])
    
    FeatureAvailable -->|Yes| RecordActivity[Record transaction creation activity]
    RecordActivity --> ValidateData[Validate transaction data]
    
    ValidateData --> AmountValid{Amount<br/>valid?}
    AmountValid -->|No| A2[Return error: Invalid amount]
    A2 --> End6([End: No transaction created])
    
    AmountValid -->|Yes| DescriptionValid{Description<br/>valid?}
    DescriptionValid -->|No| A3[Return error: Missing description]
    A3 --> End7([End: No transaction created])
    
    DescriptionValid -->|Yes| CreateRecord[Create transaction record]
    CreateRecord --> SaveTransaction[Save transaction]
    
    SaveTransaction --> SaveSuccess{Save<br/>successful?}
    SaveSuccess -->|No| A4[Return error: System error]
    A4 --> End8([End: No transaction created])
    
    SaveSuccess -->|Yes| CacheResponse{Idempotency key<br/>provided?}
    CacheResponse -->|Yes| StoreResponse[Store response with key]
    CacheResponse -->|No| ConfirmCreation
    StoreResponse --> ConfirmCreation[Confirm successful creation]
    
    ConfirmCreation --> End9([End: Transaction created])
    
    %% Styling
    classDef basicFlow fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef alternativeFlow fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef decision fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef endNode fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    
    class ValidateFormat,CheckFeature,RecordActivity,ValidateData,CreateRecord,SaveTransaction,ConfirmCreation basicFlow
    class A1,A2,A3,A4,A5_1,A5_2_1,A5_2_2,A5_2_3,A5_2_4,A6 alternativeFlow
    class CheckIdempotency,KeyFormatValid,ResponseExists,CheckExpired,CheckMatch,FormatValid,FeatureAvailable,AmountValid,DescriptionValid,SaveSuccess,CacheResponse decision
    class End1,End2,End3,End4,End5,End6,End7,End8,End9 endNode

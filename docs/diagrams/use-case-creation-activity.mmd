flowchart TD
    Start([User initiates transaction creation]) --> CheckIdempotency{Idempotency key<br/>provided?}
    
    %% Basic Flow - Main Path (highlighted)
    CheckIdempotency -->|No| ValidateFormat[Validate request format]
    ValidateFormat --> CheckFeature[Validate feature availability]
    CheckFeature --> RecordActivity[Record transaction creation activity]
    RecordActivity --> ValidateData[Validate transaction data]
    ValidateData --> CreateRecord[Create transaction record]
    CreateRecord --> SaveTransaction[Save transaction]
    SaveTransaction --> ConfirmCreation[Confirm successful creation]
    ConfirmCreation --> EndSuccess([End: Transaction created])
    
    %% Idempotency Alternative Flow Branch
    CheckIdempotency -->|Yes| ValidateKeyFormat[Validate idempotency key format]
    ValidateKeyFormat --> KeyFormatValid{Format<br/>valid?}
    
    %% Invalid Format Path
    KeyFormatValid -->|No| A5_1[Return error: Invalid key format]
    A5_1 --> EndError1([End: No transaction created])
    
    %% Valid Format - Check Previous Response
    KeyFormatValid -->|Yes| CheckPreviousResponse[Check for previous response]
    CheckPreviousResponse --> ResponseExists{Previous<br/>response<br/>exists?}
    
    %% No Previous Response - Rejoin Basic Flow
    ResponseExists -->|No| A5_2_4[New key: Continue with basic flow]
    A5_2_4 -.->|Rejoin| ValidateFormat
    
    %% Previous Response Exists
    ResponseExists -->|Yes| CheckExpired{Response<br/>expired?}
    
    %% Expired - Rejoin Basic Flow
    CheckExpired -->|Yes| A5_2_3[Remove expired record<br/>Continue with basic flow]
    A5_2_3 -.->|Rejoin| ValidateFormat
    
    %% Not Expired - Check Match
    CheckExpired -->|No| CheckMatch{Request matches<br/>previous?}
    
    %% Match Found - Return Previous Response
    CheckMatch -->|Yes| A5_2_1[Return previous response]
    A5_2_1 --> EndCached([End: Previous response returned])
    
    %% Conflict - Different Request
    CheckMatch -->|No| A5_2_2[Return error: Conflict]
    A5_2_2 --> EndConflict([End: No transaction created])
    
    %% Alternative Flows from Basic Flow Steps
    ValidateFormat --> FormatValid{Format<br/>valid?}
    FormatValid -->|No| A6[Return error: Malformed request]
    A6 --> EndError2([End: No transaction created])
    FormatValid -->|Yes| CheckFeature
    
    CheckFeature --> FeatureAvailable{Feature<br/>available?}
    FeatureAvailable -->|No| A1[Return error: Feature unavailable]
    A1 --> EndError3([End: No transaction created])
    FeatureAvailable -->|Yes| RecordActivity
    
    ValidateData --> AmountValid{Amount<br/>valid?}
    AmountValid -->|No| A2[Return error: Invalid amount]
    A2 --> EndError4([End: No transaction created])
    AmountValid -->|Yes| DescriptionValid{Description<br/>valid?}
    DescriptionValid -->|No| A3[Return error: Missing description]
    A3 --> EndError5([End: No transaction created])
    DescriptionValid -->|Yes| CreateRecord
    
    SaveTransaction --> SaveSuccess{Save<br/>successful?}
    SaveSuccess -->|No| A4[Return error: System error]
    A4 --> EndError6([End: No transaction created])
    SaveSuccess -->|Yes| ConfirmCreation
    
    %% Styling - Basic Flow is prominent
    classDef basicFlow fill:#2196F3,stroke:#0d47a1,stroke-width:4px,color:#fff,font-weight:bold
    classDef basicFlowNode fill:#42a5f5,stroke:#0277bd,stroke-width:3px,color:#fff
    classDef alternativeFlow fill:#ff9800,stroke:#e65100,stroke-width:2px
    classDef decision fill:#9c27b0,stroke:#4a148c,stroke-width:2px,color:#fff
    classDef endSuccess fill:#4caf50,stroke:#1b5e20,stroke-width:3px,color:#fff,font-weight:bold
    classDef endError fill:#f44336,stroke:#b71c1c,stroke-width:2px,color:#fff
    classDef rejoinPath stroke:#2196F3,stroke-width:3px,stroke-dasharray: 5 5
    
    %% Basic Flow Nodes (main path)
    class ValidateFormat,CheckFeature,RecordActivity,ValidateData,CreateRecord,SaveTransaction,ConfirmCreation basicFlowNode
    class Start,EndSuccess basicFlow
    class A5_2_4,A5_2_3 rejoinPath
    
    %% Alternative Flow Nodes
    class A1,A2,A3,A4,A5_1,A5_2_1,A5_2_2,A6 alternativeFlow
    
    %% Decision Nodes
    class CheckIdempotency,KeyFormatValid,ResponseExists,CheckExpired,CheckMatch,FormatValid,FeatureAvailable,AmountValid,DescriptionValid,SaveSuccess decision
    
    %% End Nodes
    class EndCached,EndConflict,EndError1,EndError2,EndError3,EndError4,EndError5,EndError6 endError

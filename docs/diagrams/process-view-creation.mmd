sequenceDiagram
    participant Client
    participant IF as IdempotencyFilter
    participant IRP as IdempotencyRepositoryPort
    participant FFF as FeatureFlagFilter
    participant FFS as FeatureFlagService
    participant Controller as TransactionController
    participant MA as MetricsAspect
    participant Service as CreateTransactionService
    participant Adapter as TransactionRepositoryAdapter
    participant DB as H2 Database
    
    Note over Client,DB: Transaction Creation Flow (with optional idempotency)
    Client->>IF: POST /transactions<br/>(optionally with Idempotency-Key header)
    
    alt Idempotency Key Present
        IF->>IRP: Check for cached response
        IRP-->>IF: No cached response (or conflict)
        Note over IF: Continue to create transaction
    end
    
    IF->>FFF: Forward request
    FFF->>FFS: Check "create-transaction" flag
    FFS-->>FFF: Feature enabled
    FFF->>Controller: Forward request
    Controller->>MA: Track "transactions.created"
    Controller->>Service: create(transaction)
    Service->>Adapter: save(transaction)
    Adapter->>DB: INSERT transaction
    DB-->>Adapter: Transaction saved
    Adapter-->>Service: Transaction domain object
    Service-->>Controller: Transaction
    
    alt Idempotency Key Present
        Controller-->>IF: Transaction response
        IF->>IRP: Cache response (key, hash, response)
        IRP-->>IF: Response cached
    end
    
    Controller-->>IF: Transaction
    IF-->>FFF: Transaction
    FFF-->>Client: HTTP 200 + Transaction
